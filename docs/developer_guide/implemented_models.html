

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Customize Models &mdash; Bigscity-LibCity  documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Customize Executors" href="implemented_executors.html" />
    <link rel="prev" title="Customize Dataset" href="implemented_datasets.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home" alt="Documentation Home"> Bigscity-LibCity
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Get Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../get_started/introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../get_started/install.html">Install LibCity</a></li>
<li class="toctree-l1"><a class="reference internal" href="../get_started/quick_start.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../get_started/directory_structure.html">Directory Structure</a></li>
</ul>
<p class="caption"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../user_guide/config_settings.html">Config Settings</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user_guide/data.html">Data Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user_guide/model.html">Reproduced Model List</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user_guide/evaluator.html">Evaluator Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user_guide/executor.html">Executor Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user_guide/usage.html">Usage</a></li>
</ul>
<p class="caption"><span class="caption-text">Developer Guide</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="code_style.html">Code Style</a></li>
<li class="toctree-l1"><a class="reference internal" href="implemented_datasets.html">Customize Dataset</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Customize Models</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#create-a-new-model-class">Create a New Model Class</a></li>
<li class="toctree-l2"><a class="reference internal" href="#implement-init">Implement __init__()</a></li>
<li class="toctree-l2"><a class="reference internal" href="#implement-predict">Implement predict()</a></li>
<li class="toctree-l2"><a class="reference internal" href="#implement-calcualte-loss">Implement calcualte_loss()</a></li>
<li class="toctree-l2"><a class="reference internal" href="#import-the-model">Import The Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="#add-model-config">Add Model Config</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="implemented_executors.html">Customize Executors</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorial</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tutorial/install_quick_start.html">Install and quick start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorial/run_model.html">Run an existing model in LibCity</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorial/add_model.html">Add a new model to LibCity</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorial/hyper_tune.html">Tuning the model with automatic tool</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorial/data_visualization.html">Visualize Atomic Files</a></li>
</ul>
<p class="caption"><span class="caption-text">API REFERENCE</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../libcity/libcity.config.html">libcity.config</a></li>
<li class="toctree-l1"><a class="reference internal" href="../libcity/libcity.data.html">libcity.data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../libcity/libcity.evaluator.html">libcity.evaluator</a></li>
<li class="toctree-l1"><a class="reference internal" href="../libcity/libcity.executor.html">libcity.executor</a></li>
<li class="toctree-l1"><a class="reference internal" href="../libcity/libcity.model.html">libcity.model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../libcity/libcity.pipeline.html">libcity.pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../libcity/libcity.utils.html">libcity.utils</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Bigscity-LibCity</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Customize Models</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/developer_guide/implemented_models.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="customize-models">
<h1>Customize Models<a class="headerlink" href="#customize-models" title="Permalink to this headline">¶</a></h1>
<p>Here, we present how to develop a new model, and apply it to the <code class="docutils literal notranslate"><span class="pre">LibCity</span></code>.</p>
<div class="section" id="create-a-new-model-class">
<h2>Create a New Model Class<a class="headerlink" href="#create-a-new-model-class" title="Permalink to this headline">¶</a></h2>
<p>To begin with, we should create a new model implementing from <code class="docutils literal notranslate"><span class="pre">AbstractModel</span></code> or <code class="docutils literal notranslate"><span class="pre">AbstractTrafficStateModel</span></code> . Note that for traffic state prediction tasks, please inherit Class <code class="docutils literal notranslate"><span class="pre">AbstractTrafficStateModel</span></code> and for trajectory location prediction tasks, please inherit Class <code class="docutils literal notranslate"><span class="pre">AbstractModel</span></code>.</p>
<p>Here we take the traffic state prediction task as an example. We would like to develop a model for traffic speed prediction task named as <code class="docutils literal notranslate"><span class="pre">NewModel</span></code>.</p>
<p>First please create a new file <code class="docutils literal notranslate"><span class="pre">NewModel.py</span></code> in the directory <code class="docutils literal notranslate"><span class="pre">libcity/model/traffic_speed_prediction/</span></code> and write the following code into the file.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">libcity.model.abstract_traffic_state_model</span> <span class="kn">import</span> <span class="n">AbstractTrafficStateModel</span>

<span class="k">class</span> <span class="nc">NewModel</span><span class="p">(</span><span class="n">AbstractTrafficStateModel</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">data_feature</span><span class="p">):</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">calculate_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
        <span class="k">pass</span>
</pre></div>
</div>
</div>
<div class="section" id="implement-init">
<h2>Implement __init__()<a class="headerlink" href="#implement-init" title="Permalink to this headline">¶</a></h2>
<p>Then we implement <code class="docutils literal notranslate"><span class="pre">__init__()</span></code> method, <code class="docutils literal notranslate"><span class="pre">__init__()</span></code> is used to define the model structure according to the data feature and the configuration information.</p>
<p>The input parameters of  <code class="docutils literal notranslate"><span class="pre">__init__()</span></code> are <code class="docutils literal notranslate"><span class="pre">config</span></code> and <code class="docutils literal notranslate"><span class="pre">data_feature</span></code>, where <code class="docutils literal notranslate"><span class="pre">config</span></code> contains various configuration information, including model parameters and so on,  and <code class="docutils literal notranslate"><span class="pre">data_feature</span></code> contains features of the dataset to build our model.</p>
<p>Here we take a simple LSTM model as an example for traffic prediction. You can define <code class="docutils literal notranslate"><span class="pre">__init__()</span></code> like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">from</span> <span class="nn">logging</span> <span class="kn">import</span> <span class="n">getLogger</span>
<span class="kn">from</span> <span class="nn">libcity.model.abstract_traffic_state_model</span> <span class="kn">import</span> <span class="n">AbstractTrafficStateModel</span>


<span class="k">class</span> <span class="nc">NewModel</span><span class="p">(</span><span class="n">AbstractTrafficStateModel</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">data_feature</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">data_feature</span><span class="p">)</span>
        <span class="c1"># section 1: data_feature</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scaler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_feature</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;scaler&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_feature</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;num_nodes&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_feature</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;feature_dim&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_feature</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;output_dim&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="n">getLogger</span><span class="p">()</span>
        <span class="c1"># section 2: model config </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_window</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;input_window&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_window</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;output_window&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;device&#39;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hidden_size</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;hidden_size&#39;</span><span class="p">,</span> <span class="mi">64</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_layers</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;num_layers&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dropout&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="c1"># section 3: model structure</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rnn</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span><span class="n">input_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_nodes</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_dim</span><span class="p">,</span> <span class="n">hidden_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hidden_size</span><span class="p">,</span>
                           <span class="n">num_layers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_layers</span><span class="p">,</span> <span class="n">dropout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hidden_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_nodes</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_dim</span><span class="p">)</span>
</pre></div>
</div>
<p>You can see that in the section 1 of the code, we take the necessary parameters from <code class="docutils literal notranslate"><span class="pre">data_feature</span></code>, including the number of nodes(<code class="docutils literal notranslate"><span class="pre">num_nodes</span></code>), data input dimensions(<code class="docutils literal notranslate"><span class="pre">feature_dim</span></code>), output dimensions(<code class="docutils literal notranslate"><span class="pre">output_dim</span></code>), and data normalized objects(<code class="docutils literal notranslate"><span class="pre">scaler</span></code>), and initialize the logger.</p>
<p>In the section 2 of the code, we take the necessary parameters from <code class="docutils literal notranslate"><span class="pre">config</span></code>, including hidden layer dimensions(<code class="docutils literal notranslate"><span class="pre">hidden_size</span></code>), network layers(<code class="docutils literal notranslate"><span class="pre">num_layers</span></code>), input time length(<code class="docutils literal notranslate"><span class="pre">input_window</span></code>), output time length(<code class="docutils literal notranslate"><span class="pre">output_window</span></code>), etc.</p>
<p>In the section 3 of the code, we define model structures, including a LSTM layer and a full connectivity layer.</p>
</div>
<div class="section" id="implement-predict">
<h2>Implement predict()<a class="headerlink" href="#implement-predict" title="Permalink to this headline">¶</a></h2>
<p>Then we define the <code class="docutils literal notranslate"><span class="pre">predict()</span></code> method, which is used to compute the prediction results of the model. The input parameters of  <code class="docutils literal notranslate"><span class="pre">predict()</span></code> is <code class="docutils literal notranslate"><span class="pre">batch</span></code>, which is an object of class <a class="reference internal" href="../user_guide/data/batch.html"><span class="doc">Batch</span></a>.</p>
<p>Both the  <code class="docutils literal notranslate"><span class="pre">AbstractModel</span></code> and <code class="docutils literal notranslate"><span class="pre">AbstractTrafficStateModel</span></code>  inherit from class <code class="docutils literal notranslate"><span class="pre">torch.nn.Module</span></code>. If you are familiar with the Pytorch framework, you will find that this function is similar to the <code class="docutils literal notranslate"><span class="pre">forward()</span></code> function in <code class="docutils literal notranslate"><span class="pre">torch.nn.Module</span></code>.  In most cases, you can call the <code class="docutils literal notranslate"><span class="pre">forward()</span></code> function directly inside this function to get the output of the model.</p>
<p>The purpose of this function is that you can do some extra processing on the basis of the model output calculated by the <code class="docutils literal notranslate"><span class="pre">forward()</span></code> function. For example, when the <code class="docutils literal notranslate"><span class="pre">forward()</span></code>  function calculates the result of single-step prediction of the model and you need the result of multi-step prediction, you can use the <code class="docutils literal notranslate"><span class="pre">predict()</span></code> function to implement it.</p>
<p>For example, you can define <code class="docutils literal notranslate"><span class="pre">predict()</span></code> like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">NewModel</span><span class="p">(</span><span class="n">AbstractTrafficStateModel</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
        <span class="n">src</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="n">src</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">src</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_window</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_nodes</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_dim</span><span class="p">)</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_window</span><span class="p">):</span>
            <span class="n">out</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rnn</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
            <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_nodes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_dim</span><span class="p">)</span>
            <span class="n">outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">clone</span><span class="p">())</span>
            <span class="n">src</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">src</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="n">out</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                <span class="n">batch_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_nodes</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_dim</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">outputs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">outputs</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
</pre></div>
</div>
<p>It can be seen that the <code class="docutils literal notranslate"><span class="pre">predict</span></code> function calls the <code class="docutils literal notranslate"><span class="pre">forward</span></code> function directly, and in the <code class="docutils literal notranslate"><span class="pre">forward</span></code> function, we define the calculation process of the model. This model uses LSTM to make multiple predictions, and takes the output of each predicted as the next input.  Here we assume that the input data dimension and output data dimension are equal, that is <code class="docutils literal notranslate"><span class="pre">feature_dim=output_dim</span></code>.</p>
</div>
<div class="section" id="implement-calcualte-loss">
<h2>Implement calcualte_loss()<a class="headerlink" href="#implement-calcualte-loss" title="Permalink to this headline">¶</a></h2>
<p>Finally we define the <code class="docutils literal notranslate"><span class="pre">calculate_loss()</span></code> method, <code class="docutils literal notranslate"><span class="pre">calculate_loss()</span></code> is used to compute the loss between the prediction results and the ground-truth value.</p>
<p>The input parameters of  <code class="docutils literal notranslate"><span class="pre">calculate_loss()</span></code> is <code class="docutils literal notranslate"><span class="pre">batch</span></code>, which is an object of class <a class="reference internal" href="../user_guide/data/batch.html"><span class="doc">Batch</span></a>. And the method return a <code class="docutils literal notranslate"><span class="pre">torch.Tensor</span></code> for back propagation.</p>
<p>You can customize the loss function or call the loss function we defined in the <code class="docutils literal notranslate"><span class="pre">libcity/model/loss.py</span></code> file.</p>
<p>For example, you can define <code class="docutils literal notranslate"><span class="pre">calcualte_loss()</span></code> like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">libcity.model</span> <span class="kn">import</span> <span class="n">loss</span>

<span class="k">class</span> <span class="nc">NewModel</span><span class="p">(</span><span class="n">AbstractTrafficStateModel</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">calculate_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
        <span class="n">y_true</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span>
        <span class="n">y_predicted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
        <span class="n">y_true</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scaler</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">y_true</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dim</span><span class="p">])</span>
        <span class="n">y_predicted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scaler</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">y_predicted</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dim</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">loss</span><span class="o">.</span><span class="n">masked_mae_torch</span><span class="p">(</span><span class="n">y_predicted</span><span class="p">,</span> <span class="n">y_true</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<p>You can see that here we directly call the <code class="docutils literal notranslate"><span class="pre">loss.masked_mae_torch</span></code> function that has been defined in <code class="docutils literal notranslate"><span class="pre">loss.py</span></code>, its function is to calculate the MAE loss.</p>
<p>Now we have completed the definition of the model structure, and there are some simple configurations left.</p>
</div>
<div class="section" id="import-the-model">
<h2>Import The Model<a class="headerlink" href="#import-the-model" title="Permalink to this headline">¶</a></h2>
<p>After adding the model, you need to modify the <code class="docutils literal notranslate"><span class="pre">__init__.py</span></code> file in the task folder where your model belongs.  In the example above, the file you need to modify is <code class="docutils literal notranslate"><span class="pre">libcity/model/traffic_speed_prediction/__init__.py</span></code>.</p>
<p>Please add code like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">libcity.model.traffic_speed_prediction.NewModel</span> <span class="kn">import</span> <span class="n">NewModel</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;NewModel&quot;</span><span class="p">,</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
<div class="section" id="add-model-config">
<h2>Add Model Config<a class="headerlink" href="#add-model-config" title="Permalink to this headline">¶</a></h2>
<p>Finally, you need to modify some relevant <code class="docutils literal notranslate"><span class="pre">config</span></code> files.</p>
<ul>
<li><p>First, you need to modify the <code class="docutils literal notranslate"><span class="pre">libcity/config/task_config.json</span></code>, which is used to set the models and datasets supported by each task, and specify the basic parameters (data module, execution module, evaluation module) used by the model.</p>
<p>For example, you can add codes like the follows, which means the data module class used by <code class="docutils literal notranslate"><span class="pre">NewModel</span></code> is <code class="docutils literal notranslate"><span class="pre">TrafficStatePointDataset</span></code>, the execution module class is <code class="docutils literal notranslate"><span class="pre">TrafficStateExecutor</span></code>, and the evaluation module class is <code class="docutils literal notranslate"><span class="pre">TrafficStateEvaluator</span></code>.</p>
</li>
</ul>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;traffic_state_pred&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;allowed_model&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;NewModel&quot;</span><span class="p">],</span>
        <span class="nt">&quot;allowed_dataset&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">],</span>
        <span class="nt">&quot;NewModel&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;dataset_class&quot;</span><span class="p">:</span> <span class="s2">&quot;TrafficStatePointDataset&quot;</span><span class="p">,</span>
            <span class="nt">&quot;executor&quot;</span><span class="p">:</span> <span class="s2">&quot;TrafficStateExecutor&quot;</span><span class="p">,</span>
            <span class="nt">&quot;evaluator&quot;</span><span class="p">:</span> <span class="s2">&quot;TrafficStateEvaluator&quot;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<ul>
<li><p>Second, you need to add a file in the <code class="docutils literal notranslate"><span class="pre">libcity/config/model/</span></code> directory to set the default parameters of your model. You can also set parameters of other modules which you want to cover as the parameters of the model module have the highest priority than other modules.</p>
<p>For example, you can add this file <code class="docutils literal notranslate"><span class="pre">libcity/config/model/traffic_state_pred/NewModel.json</span></code> and add codes like the follows. You can see that in addition to the three parameters related to the model structure, we also define the number of training rounds(<code class="docutils literal notranslate"><span class="pre">max_epoch</span></code>), optimizer(<code class="docutils literal notranslate"><span class="pre">learner</span></code>), and learning rate(<code class="docutils literal notranslate"><span class="pre">learning_rate</span></code>) to cover the default execution configuration.</p>
</li>
</ul>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;hidden_size&quot;</span><span class="p">:</span> <span class="mi">64</span><span class="p">,</span>
  <span class="nt">&quot;num_layers&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="nt">&quot;dropout&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>

  <span class="nt">&quot;max_epoch&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
  <span class="nt">&quot;learner&quot;</span><span class="p">:</span> <span class="s2">&quot;adam&quot;</span><span class="p">,</span>
  <span class="nt">&quot;learning_rate&quot;</span><span class="p">:</span> <span class="mf">0.001</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Note: The filename of the config and the value in <code class="docutils literal notranslate"><span class="pre">allowed_model</span></code> list must be the same as the class name of the model you added.</strong>  Just like the <code class="docutils literal notranslate"><span class="pre">NewModel</span></code> above.</p>
<p>Now that you have learned how to add a new model, try the following commands to run this model!</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>python run_model.py --task traffic_state_pred --model NewModel --dataset METR_LA
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="implemented_executors.html" class="btn btn-neutral float-right" title="Customize Executors" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="implemented_datasets.html" class="btn btn-neutral float-left" title="Customize Dataset" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, aptx1231

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>